name: ğŸ›¡ï¸ StellarSpeak Site Guardian

on:
  schedule:
    # ÙØ­Øµ ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª
    - cron: '0 */5 * * *'
    # ÙØ­Øµ Ø³Ø±ÙŠØ¹ ÙƒÙ„ Ø³Ø§Ø¹Ø© ÙÙŠ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ© (8Øµ - 10Ù…)
    - cron: '0 8-22 * * *'
  
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - telegram-test

jobs:
  site-monitoring:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps chromium
      timeout-minutes: 10
    
    - name: ğŸ›¡ï¸ Run Site Guardian Tests
      id: tests
      run: |
        npx playwright test --reporter=json > test-results.json 2>&1 || echo "Tests completed"
        echo "tests_completed=true" >> $GITHUB_OUTPUT
      env:
        SITE_URL: https://www.stellarspeak.online
        TEST_TYPE: ${{ github.event.inputs.test_type || 'full' }}
        MONITOR_EMAIL: ${{ secrets.MONITOR_EMAIL }}
        MONITOR_PASSWORD: ${{ secrets.MONITOR_PASSWORD }}
      timeout-minutes: 15
    
    - name: ğŸ“Š Parse Test Results
      id: parse_results
      run: |
        node -e "
        const fs = require('fs');
        try {
          let results = {};
          let stats = { expected: 0, passed: 0, failed: 0, skipped: 0 };
          
          if (fs.existsSync('test-results.json')) {
            const content = fs.readFileSync('test-results.json', 'utf8');
            results = JSON.parse(content);
            stats = results.stats || stats;
          }
          
          const total = stats.expected || 0;
          const passed = stats.passed || 0;
          const failed = stats.failed || 0;
          const skipped = stats.skipped || 0;
          
          const status = failed > 0 ? 'ğŸ”´ FAILED' : 'âœ… PASSED';
          const timestamp = new Date().toLocaleString('ar-SA', {timeZone: 'Asia/Riyadh'});
          
          let message = 'ğŸ›¡ï¸ **StellarSpeak Site Guardian Report**\n\n';
          message += 'ğŸ“Š **Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ:**\n';
          message += 'âœ… Ù†Ø¬Ø­: ' + passed + ' Ø§Ø®ØªØ¨Ø§Ø±\n';
          message += 'âŒ ÙØ´Ù„: ' + failed + ' Ø§Ø®ØªØ¨Ø§Ø±\n';
          message += 'â­ï¸ ØªÙ… ØªØ®Ø·ÙŠÙ‡: ' + skipped + ' Ø§Ø®ØªØ¨Ø§Ø±\n';
          message += 'ğŸ“ˆ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ' + total + ' Ø§Ø®ØªØ¨Ø§Ø±\n\n';
          message += 'â° **Ø§Ù„ÙˆÙ‚Øª:** ' + timestamp + '\n';
          message += 'ğŸŒ **Ø§Ù„Ù…ÙˆÙ‚Ø¹:** https://www.stellarspeak.online\n\n';
          
          if (failed > 0) {
            message += 'âš ï¸ **ØªØ­Ø°ÙŠØ±:** ØªÙ… Ø§ÙƒØªØ´Ø§Ù ' + failed + ' Ù…Ø´ÙƒÙ„Ø© ØªØ­ØªØ§Ø¬ ÙØ­Øµ!\n';
            message += 'ğŸ” **ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„**\n\n';
          } else if (passed > 0) {
            message += 'âœ… **Ù…Ù…ØªØ§Ø²! Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ**\n';
            message += 'ğŸš€ **Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª Ø¨Ù„Ø§ Ù…Ø´Ø§ÙƒÙ„**\n\n';
          } else {
            message += 'âš ï¸ **ØªØ­Ø°ÙŠØ±:** Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªØŒ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©\n\n';
          }
          
          message += 'ğŸ“‹ [Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
          
          console.log('TELEGRAM_MESSAGE<<EOF');
          console.log(message);
          console.log('EOF');
          
          fs.writeFileSync('telegram-message.txt', message);
          
        } catch (error) {
          const errorTime = new Date().toLocaleString('ar-SA', {timeZone: 'Asia/Riyadh'});
          const errorMessage = 'ğŸš¨ **Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ù…ÙˆÙ‚Ø¹ StellarSpeak**\n\n' +
            'âŒ **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** ØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ\n' +
            'â° **Ø§Ù„ÙˆÙ‚Øª:** ' + errorTime + '\n' +
            'ğŸ”§ **Ù…Ø·Ù„ÙˆØ¨:** ÙØ­Øµ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©\n\n' +
            'ğŸ“‹ [Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
          
          console.log('TELEGRAM_MESSAGE<<EOF');
          console.log(errorMessage);
          console.log('EOF');
          
          fs.writeFileSync('telegram-message.txt', errorMessage);
        }
        " >> $GITHUB_ENV
      continue-on-error: true
    
    - name: ğŸ“¤ Send Telegram Notification
      if: always()
      run: |
        if [ -f "telegram-message.txt" ]; then
          MESSAGE=$(cat telegram-message.txt)
        else
          MESSAGE="ğŸ›¡ï¸ **StellarSpeak Site Check Ù…ÙƒØªÙ…Ù„**
          
        â° **Ø§Ù„ÙˆÙ‚Øª:** $(date '+%Y-%m-%d %H:%M:%S')
        ğŸŒ **Ø§Ù„Ù…ÙˆÙ‚Ø¹:** https://www.stellarspeak.online
        ğŸ“‹ **Ø§Ù„ØªÙØ§ØµÙŠÙ„:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        fi
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Telegram
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$MESSAGE\",
            \"parse_mode\": \"Markdown\",
            \"disable_web_page_preview\": true
          }" || echo "âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Telegram"
    
    - name: ğŸ“Š Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: site-guardian-report-${{ github.run_number }}
        path: |
          test-results/
          playwright-report/
          test-results.json
          telegram-message.txt
        retention-days: 30

    # Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
    - name: ğŸš¨ Send Detailed Alert on Critical Failure
      if: failure()
      run: |
        ALERT_MESSAGE="ğŸš¨ **ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ø¬Ù„ - Ù…Ø´ÙƒÙ„Ø© Ø­Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹**

        âŒ **Ø­Ø§Ù„Ø© Ø§Ù„ÙØ­Øµ:** ÙØ´Ù„ ÙƒØ§Ù…Ù„
        ğŸ” **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØ­Øµ Ù†ÙØ³Ù‡Ø§
        â° **Ø§Ù„ÙˆÙ‚Øª:** $(date '+%Y-%m-%d %H:%M:%S')
        
        ğŸŒ **Ø§Ù„Ù…ÙˆÙ‚Ø¹:** https://www.stellarspeak.online
        ğŸ“‹ **Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„:**
        â€¢ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹
        â€¢ Ø®Ø·Ø£ ÙÙŠ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ÙØ­Øµ
        â€¢ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…

        ğŸ”§ **Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø¬Ø±Ø§Ø¡ ÙÙˆØ±ÙŠ:**
        1ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹
        2ï¸âƒ£ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…
        3ï¸âƒ£ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹

        ğŸ“‹ [Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ÙƒØ§Ù…Ù„Ø©](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$ALERT_MESSAGE\",
            \"parse_mode\": \"Markdown\"
          }"
