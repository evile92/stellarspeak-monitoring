name: ğŸ›¡ï¸ StellarSpeak Site Guardian

on:
  schedule:
    # ÙØ­Øµ ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª
    - cron: '0 */5 * * *'
    # ÙØ­Øµ Ø³Ø±ÙŠØ¹ ÙƒÙ„ Ø³Ø§Ø¹Ø© ÙÙŠ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ©
    - cron: '0 8-22 * * *'
  
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - telegram-test

jobs:
  site-monitoring:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps chromium
    
    - name: ğŸ›¡ï¸ Run Site Guardian Tests
      id: tests
      run: |
        npx playwright test --reporter=json > test-results.json || echo "Tests completed"
        echo "tests_completed=true" >> $GITHUB_OUTPUT
      env:
        SITE_URL: https://www.stellarspeak.online
        TEST_TYPE: ${{ github.event.inputs.test_type || 'full' }}
    
    - name: ğŸ“Š Parse Test Results
      id: parse_results
      run: |
        # ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±
        node -e "
        const fs = require('fs');
        try {
          const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
          const stats = results.stats || {};
          const total = stats.expected || 0;
          const passed = stats.passed || 0;
          const failed = stats.failed || 0;
          const skipped = stats.skipped || 0;
          
          const status = failed > 0 ? 'ğŸ”´ FAILED' : 'ğŸŸ¢ PASSED';
          const timestamp = new Date().toLocaleString('ar-SA', {timeZone: 'Asia/Riyadh'});
          
          let message = 'ğŸ›¡ï¸ **StellarSpeak Site Report**\n\n';
          message += 'ğŸ“Š **Ø§Ù„Ù†ØªØ§Ø¦Ø¬:**\n';
          message += 'âœ… Ù†Ø¬Ø­: ' + passed + '\n';
          message += 'âŒ ÙØ´Ù„: ' + failed + '\n';
          message += 'â­ï¸ ØªÙ… ØªØ®Ø·ÙŠÙ‡: ' + skipped + '\n';
          message += 'ğŸ“ˆ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ' + total + '\n\n';
          message += 'â° **Ø§Ù„ÙˆÙ‚Øª:** ' + timestamp + '\n';
          message += 'ğŸŒ **Ø§Ù„Ù…ÙˆÙ‚Ø¹:** https://www.stellarspeak.online\n\n';
          
          if (failed > 0) {
            message += 'âš ï¸ **ØªØ­Ø°ÙŠØ±:** ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø´Ø§ÙƒÙ„ ØªØ­ØªØ§Ø¬ ÙØ­Øµ!\n';
          } else {
            message += 'âœ… **Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ù…ØªØ§Ø²!**\n';
          }
          
          message += '\nğŸ“‹ **ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±:** [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
          
          console.log('TELEGRAM_MESSAGE=' + encodeURIComponent(message));
          
          // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù…Ù„Ù
          fs.writeFileSync('telegram-message.txt', message);
          
        } catch (error) {
          const errorMessage = 'ğŸš¨ **Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹!**\n\nØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.\nâ° Ø§Ù„ÙˆÙ‚Øª: ' + new Date().toLocaleString('ar-SA') + '\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
          console.log('TELEGRAM_MESSAGE=' + encodeURIComponent(errorMessage));
          fs.writeFileSync('telegram-message.txt', errorMessage);
        }
        "
      continue-on-error: true
    
    - name: ğŸ“¤ Send Telegram Notification
      if: always()
      run: |
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù
        if [ -f "telegram-message.txt" ]; then
          MESSAGE=$(cat telegram-message.txt)
        else
          MESSAGE="ğŸ›¡ï¸ StellarSpeak Site Check Completed
        
        â° Time: $(date '+%Y-%m-%d %H:%M:%S')
        ğŸ”— Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        fi
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Telegram
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$MESSAGE\",
            \"parse_mode\": \"Markdown\",
            \"disable_web_page_preview\": true
          }" || echo "Failed to send Telegram message"
    
    - name: ğŸ“Š Upload Detailed Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: site-guardian-report-${{ github.run_number }}
        path: |
          test-results/
          playwright-report/
          test-results.json
        retention-days: 30

    # Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙØ´Ù„
    - name: ğŸ“‹ Send Detailed Report on Failure
      if: failure()
      run: |
        DETAILED_MESSAGE="ğŸš¨ **ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ - Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹**

        ğŸ” **Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:**
        â€¢ ÙØ´Ù„ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        â€¢ ÙŠØ­ØªØ§Ø¬ ÙØ­Øµ ÙÙˆØ±ÙŠ

        â° **Ø§Ù„ÙˆÙ‚Øª:** $(date '+%Y-%m-%d %H:%M:%S')
        ğŸŒ **Ø§Ù„Ù…ÙˆÙ‚Ø¹:** https://www.stellarspeak.online

        ğŸ“‹ **Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„:** 
        ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        ğŸ”§ **Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:**
        1. ÙØ­Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„
        2. ØªØ­Ø¯ÙŠØ¯ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©  
        3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©"

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$DETAILED_MESSAGE\",
            \"parse_mode\": \"Markdown\"
          }"
