name: ðŸ›¡ï¸ StellarSpeak Site Guardian

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test Type'
        required: false
        default: 'quick'
        type: choice
        options:
        - quick
        - full

jobs:
  site-monitoring:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.56.0-jammy
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ðŸ“¦ Install Dependencies
      run: |
        echo "ðŸ“¦ Installing dev dependencies from package.json..."
        npm install --only=dev
        echo "âœ… Dependencies installed"

    - name: ðŸ” Debug Environment
      run: |
        echo "ðŸ“Š Environment Info:"
        echo "Node: $(node --version)"
        echo "NPM: $(npm --version)"
        echo "PWD: $(pwd)"
        echo "Files:"
        ls -la
        echo "Playwright:"
        npx playwright --version

    - name: ðŸ›¡ï¸ Run Site Guardian Tests
      id: tests
      run: |
        echo "ðŸ” Starting Playwright tests..."
        echo "ðŸŒ Target: $SITE_URL"
        
        set +e
        npx playwright test
        EXIT_CODE=$?
        set -e
        
        echo "ðŸ“Š Test execution finished with exit code: $EXIT_CODE"
        
        if [ -f "test-results.json" ]; then
          echo "âœ… test-results.json found!"
          echo "ðŸ“„ Content preview:"
          head -50 test-results.json
        else
          echo "âŒ test-results.json NOT found!"
          echo "ðŸ“ Current directory files:"
          ls -la
          echo "ðŸ“ Searching for JSON files:"
          find . -name "*.json" -type f 2>/dev/null || true
          
          echo '{"suites":[],"errors":[],"stats":{"startTime":"'$(date -Iseconds)'","duration":0,"expected":0,"skipped":0,"unexpected":0,"flaky":0}}' > test-results.json
          echo "âš ï¸ Created empty test-results.json with Playwright format"
        fi
        
        echo "tests_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
      env:
        SITE_URL: https://www.stellarspeak.online
        TEST_TYPE: ${{ github.event.inputs.test_type || 'quick' }}
        MONITOR_EMAIL: ${{ secrets.MONITOR_EMAIL }}
        MONITOR_PASSWORD: ${{ secrets.MONITOR_PASSWORD }}
      timeout-minutes: 12
      continue-on-error: true

    - name: ðŸ“Š Parse Test Results
      run: |
        node -e "
        const fs = require('fs');
        console.log('ðŸ” Parsing test results...');
        
        try {
          let testResults = { suites: [], errors: [], stats: {} };
          let failedTests = [];
          
          // ØªØ­Ø³ÙŠÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø£ÙØ¶Ù„
          if (fs.existsSync('test-results.json')) {
            const content = fs.readFileSync('test-results.json', 'utf8').trim();
            console.log('ðŸ“„ File size:', content.length, 'bytes');
            
            if (content && content.length > 10) {
              try {
                testResults = JSON.parse(content);
                console.log('âœ… Successfully parsed Playwright results');
              } catch (parseError) {
                console.error('âŒ JSON Parse Error:', parseError.message);
                console.log('First 200 chars of file:', content.substring(0, 200));
                throw parseError;
              }
            } else {
              console.warn('âš ï¸ File is empty or too small');
            }
          } else {
            console.error('âŒ test-results.json not found');
            throw new Error('test-results.json file not found');
          }

          function parseSuites(suites, parentTitle = '') {
            if (!suites) return;
            for (const suite of suites) {
              const currentTitle = parentTitle ? \`\${parentTitle} > \${suite.title}\` : suite.title;
              if (suite.specs) {
                for (const spec of suite.specs) {
                  const failedRun = spec.tests.flatMap(t => t.results).find(r => r.status === 'failed' || r.status === 'timedOut');
                  if (failedRun) {
                    let errorMsg = 'No error message';
                    if (failedRun.error) {
                      errorMsg = failedRun.error.message ? failedRun.error.message.split('\\n')[0] : (failedRun.error.value || 'Error');
                    }
                    failedTests.push({
                      title: \`\${currentTitle} > \${spec.title}\`.replace(/^ > | > \$/g, ''),
                      error: errorMsg.substring(0, 150)
                    });
                  }
                }
              }
              if (suite.suites) {
                parseSuites(suite.suites, currentTitle);
              }
            }
          }
          
          parseSuites(testResults.suites);

          const stats = testResults.stats || {};
          const expected = stats.expected || 0;
          const unexpected = stats.unexpected || 0;
          const skipped = stats.skipped || 0;
          const flaky = stats.flaky || 0;
          const total = expected + unexpected + skipped + flaky;
          const duration = (stats.duration / 1000).toFixed(1);
          
          let status;
          if (total === 0) status = 'ðŸ”´ NO_TESTS';
          else if (unexpected > 0) status = 'ðŸ”´ FAILED';
          else if (expected > 0) status = 'âœ… PASSED';
          else status = 'âš ï¸ UNKNOWN';
          
          const timestamp = new Date().toLocaleString('en-US', { 
            timeZone: 'Africa/Casablanca',
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit', 
            hour12: false 
          });
          
          let message = 'ðŸ›¡ï¸ *StellarSpeak Site Guardian Report*\\\\\\\\n';
          message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\\\\\n\\\\\\\\n';
          message += 'ðŸ“Š *Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ:*\\\\\\\\n';
          message += 'â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ' + status + '\\\\\\\\n';
          message += 'â€¢ Ù†Ø¬Ø­: âœ… ' + expected + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\\\\\n';
          message += 'â€¢ ÙØ´Ù„: âŒ ' + unexpected + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\\\\\n';
          message += 'â€¢ ØªÙ… ØªØ®Ø·ÙŠÙ‡: â­ï¸ ' + skipped + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\\\\\n';
          message += 'â€¢ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ðŸ“ˆ ' + total + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\\\\\n';
          message += 'â€¢ Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°: â±ï¸ ' + duration + ' Ø«Ø§Ù†ÙŠØ©\\\\\\\\n\\\\\\\\n';
          message += 'ðŸ” *Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ­Øµ:*\\\\\\\\n';
          message += 'â€¢ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ðŸŒ [stellarspeak.online](https://www.stellarspeak.online)\\\\\\\\n';
          message += 'â€¢ Ø§Ù„ÙˆÙ‚Øª: ðŸ• ' + timestamp + ' (Casablanca Time)\\\\\\\\n';
          message += 'â€¢ Ù†ÙˆØ¹ Ø§Ù„ØªØ´ØºÙŠÙ„: ðŸ”„ ' + ('\${{ github.event_name }}' === 'schedule' ? 'ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ„ 12 Ø³Ø§Ø¹Ø©)' : 'ÙŠØ¯ÙˆÙŠ') + '\\\\\\\\n';
          message += 'â€¢ Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: #\${{ github.run_number }}\\\\\\\\n\\\\\\\\n';
          
          if (unexpected > 0) {
            message += 'âš ï¸ *ØªØ­Ø°ÙŠØ± - Ù…Ø´Ø§ÙƒÙ„ Ù…ÙƒØªØ´ÙØ© (' + unexpected + '):*\\\\\\\\n';
            message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\\\\\n';
            message += 'ðŸ” *ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Ø£ÙˆÙ„ 5):*\\\\\\\\n';
            failedTests.slice(0, 5).forEach((test, index) => {
              const cleanTitle = test.title.replace(/[*_\`\\[\\]]/g, '');
              const cleanError = test.error.replace(/[*_\`\\[\\]]/g, '');
              message += (index + 1) + '. *' + cleanTitle + '*\\\\\\\\n';
              message += '   â”” ðŸ“„: \`' + cleanError + '...\`\\\\\\\\n\\\\\\\\n';
            });
            if (failedTests.length > 5) {
               message += '... ÙˆØ§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„.\\\\\\\\n\\\\\\\\n';
            }
          } else if (total === 0) {
            message += 'ðŸš¨ *Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ - Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:*\\\\\\\\n';
            message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\\\\\n';
            message += 'ðŸ”§ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Playwright Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¦Ø©\\\\\\\\n\\\\\\\\n';
          } else if (expected > 0) {
            message += 'âœ… *Ù…Ù…ØªØ§Ø² - Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!*\\\\\\\\n';
            message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\\\\\n';
            message += 'ðŸš€ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (' + expected + ') Ù†Ø¬Ø­Øª Ø¨Ù„Ø§ Ù…Ø´Ø§ÙƒÙ„\\\\\\\\n\\\\\\\\n';
          }
          
          message += 'ðŸ“‹ *Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©:*\\\\\\\\n';
          message += 'â€¢ [Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±](https://github.com/\${{ github.repository }}/actions/runs/\${{ github.run_id }})\\\\\\\\n';
          message += 'â€¢ [Ø§Ù„Ù…ÙˆÙ‚Ø¹](https://www.stellarspeak.online)\\\\\\\\n';
          
          fs.writeFileSync('telegram-message.txt', message);
          console.log('âœ… Telegram message created successfully');
          console.log('Status:', status);

        } catch (error) {
          console.error('âŒ CRITICAL ERROR in Parse Test Results:');
          console.error('Error name:', error.name);
          console.error('Error message:', error.message);
          console.error('Stack:', error.stack);
          
          // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù€ Telegram
          const errorMessage = 'ðŸš¨ *CRITICAL: Parse Results Failed*\\\\\\\\n' +
            'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\\\\\n' +
            'âŒ Error: ' + error.message + '\\\\\\\\n\\\\\\\\n' +
            'ðŸ”— [View Logs](https://github.com/\${{ github.repository }}/actions/runs/\${{ github.run_id }})';
          
          fs.writeFileSync('telegram-message.txt', errorMessage);
          console.log('âš ï¸ Created error message file');
          
          process.exit(1);
        }
        "
      continue-on-error: true

    - name: ðŸ›¡ï¸ Ensure Message File Exists (Fallback)
      if: always()
      run: |
        if [ ! -f "telegram-message.txt" ]; then
          echo "âŒ 'Parse Test Results' failed. Creating fallback message..."
          
          cat > telegram-message.txt << 'EOF'
ðŸš¨ *CRITICAL: Workflow Failure*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n
âš ï¸ *System Alert:*\\nThe 'Parse Test Results' step failed to run correctly.\\nThis means \`test-results.json\` might be missing or the Node.js script has an error.\\n\\n
ðŸ” *Action Required:*\\nPlease check the GitHub Actions logs immediately for the *'Parse Test Results'* step to see the error details.\\n\\n
ðŸ”— [View Failed Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
EOF
          
          echo "âœ… Fallback message created"
        else
          echo "âœ… Message file exists, no fallback needed"
        fi

    - name: ðŸ” Debug Secrets
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ” Checking Telegram Secrets..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          TOKEN_LENGTH=$(echo -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" | wc -c)
          echo "âœ… TELEGRAM_BOT_TOKEN is set (length: $TOKEN_LENGTH characters)"
        else
          echo "âŒ TELEGRAM_BOT_TOKEN is NOT set"
        fi
        
        if [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          echo "âœ… TELEGRAM_CHAT_ID is set: ${{ secrets.TELEGRAM_CHAT_ID }}"
        else
          echo "âŒ TELEGRAM_CHAT_ID is NOT set"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: ðŸ“¤ Send Telegram Notification
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message_file: telegram-message.txt
        format: markdown
        disable_web_page_preview: true

    - name: ðŸ“Š Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: site-guardian-report-${{ github.run_number }}
        path: |
          test-results/
          playwright-report/
          test-results.json
          telegram-message.txt
        retention-days: 30
        if-no-files-found: warn

    - name: ðŸš¨ Send Detailed Alert on Critical Failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ðŸš¨ **CRITICAL: StellarSpeak Monitoring System Failure**
          
          âŒ **Issue:** Complete system failure during workflow execution
          â° **Time:** $(date)
          ðŸ”§ **Run:** #${{ github.run_number }}
          
          ðŸš€ **Action Required:** â€¢ Manual site check immediately
          â€¢ Review GitHub Actions logs
          â€¢ Verify system configuration
          
          ðŸ”— [View Detailed Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        format: markdown
