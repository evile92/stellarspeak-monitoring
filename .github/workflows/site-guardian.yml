name: ğŸ›¡ï¸ StellarSpeak Site Guardian

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ'
        required: true
        default: 'quick'
        type: choice
        options:
        - quick
        - full
        - telegram-test

jobs:
  site-monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm install -D @playwright/test
        npx playwright install chromium
      timeout-minutes: 8
    
    - name: ğŸ›¡ï¸ Run Simple Site Check
      id: site_check
      run: |
        echo "ğŸ” Starting StellarSpeak health check..."
        echo "ğŸ“Š Site URL: $SITE_URL"
        
        # ØªØ´ØºÙŠÙ„ Playwright Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ù…Ù„Ø©
        if timeout 120s npx playwright test --reporter=json:test-results.json; then
          echo "âœ… Playwright tests completed successfully"
          TEST_STATUS="success"
        else
          EXIT_CODE=$?
          echo "âš ï¸ Playwright tests completed with exit code: $EXIT_CODE"
          TEST_STATUS="completed_with_issues"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù†ØªØ§Ø¦Ø¬ ÙŠÙˆØ¶Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
          echo "{\"stats\":{\"expected\":1,\"passed\":0,\"failed\":1,\"skipped\":0},\"duration\":1000}" > test-results.json
        fi
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        if [ -f "test-results.json" ]; then
          echo "ğŸ“Š Test results file exists ($(wc -c < test-results.json) bytes)"
          cat test-results.json
        else
          echo "âŒ No results file found - creating default"
          echo '{"stats":{"expected":1,"passed":0,"failed":1,"skipped":0},"duration":0}' > test-results.json
        fi
        
        echo "test_status=$TEST_STATUS" >> $GITHUB_OUTPUT
      env:
        SITE_URL: https://www.stellarspeak.online
        TEST_TYPE: ${{ github.event.inputs.test_type || 'quick' }}
      timeout-minutes: 12
    
    - name: ğŸ“Š Create Telegram Report
      id: create_report
      run: |
        node -e "
        const fs = require('fs');
        
        console.log('ğŸ“Š Creating Telegram report...');
        
        let testResults = {
          stats: { expected: 1, passed: 0, failed: 1, skipped: 0 },
          duration: 0
        };
        
        // Ù‚Ø±Ø§Ø¡Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        try {
          if (fs.existsSync('test-results.json')) {
            const content = fs.readFileSync('test-results.json', 'utf8');
            if (content.trim()) {
              testResults = JSON.parse(content);
            }
          }
        } catch (error) {
          console.log('âš ï¸ Error reading test results, using defaults');
        }
        
        const stats = testResults.stats || {};
        const total = stats.expected || 0;
        const passed = stats.passed || 0;
        const failed = stats.failed || 0;
        const skipped = stats.skipped || 0;
        const duration = testResults.duration ? (testResults.duration / 1000).toFixed(1) : '0';
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        let finalStatus;
        let statusIcon;
        
        if (total === 0) {
          finalStatus = 'Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª';
          statusIcon = 'ğŸ”´';
        } else if (passed > 0 && failed === 0) {
          finalStatus = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª';
          statusIcon = 'âœ…';
        } else if (failed > 0) {
          finalStatus = 'Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª';
          statusIcon = 'âš ï¸';
        } else {
          finalStatus = 'Ø­Ø§Ù„Ø© ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©';
          statusIcon = 'â“';
        }
        
        const timestamp = new Date().toLocaleString('ar-SA-u-nu-latn', {timeZone: 'Asia/Riyadh'});
        const testType = '${{ github.event.inputs.test_type || \"ØªÙ„Ù‚Ø§Ø¦ÙŠ\" }}';
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ„ØºØ±Ø§Ù…
        let message = 'ğŸ›¡ï¸ *ØªÙ‚Ø±ÙŠØ± Ù…Ø±Ø§Ù‚Ø¨Ø© StellarSpeak*\\n';
        message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';
        
        message += statusIcon + ' *Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©:* ' + finalStatus + '\\n\\n';
        
        message += 'ğŸ“Š *ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:*\\n';
        message += 'â€¢ Ù†Ø¬Ø­: âœ… ' + passed + '\\n';
        message += 'â€¢ ÙØ´Ù„: âŒ ' + failed + '\\n';
        message += 'â€¢ ØªÙ… ØªØ®Ø·ÙŠÙ‡: â­ï¸ ' + skipped + '\\n';
        message += 'â€¢ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ğŸ“ˆ ' + total + '\\n';
        message += 'â€¢ Ø§Ù„Ù…Ø¯Ø©: â±ï¸ ' + duration + 's\\n\\n';
        
        message += 'ğŸ” *Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:*\\n';
        message += 'â€¢ Ø§Ù„Ù…ÙˆÙ‚Ø¹: [stellarspeak.online](https://www.stellarspeak.online)\\n';
        message += 'â€¢ Ø§Ù„ÙˆÙ‚Øª: ğŸ• ' + timestamp + '\\n';
        message += 'â€¢ Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ: ğŸ”§ ' + testType + '\\n';
        message += 'â€¢ Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: #${{ github.run_number }}\\n\\n';
        
        // Ø±Ø³Ø§Ø¦Ù„ Ù…Ø®ØªÙ„ÙØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (passed > 0 && failed === 0) {
          message += 'ğŸ‰ *Ù…Ù…ØªØ§Ø²!* Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ\\n';
          message += 'ğŸ’š Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù†Ø¬Ø­Øª\\n';
          message += 'ğŸ¯ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ ØªØ¯Ø®Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ\\n';
        } else if (total === 0) {
          message += 'ğŸ”§ *ØªÙ†Ø¨ÙŠÙ‡ ØªÙ‚Ù†ÙŠ:* Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª\\n';
          message += 'âš ï¸ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…\\n';
          message += 'ğŸ” ÙŠÙÙ†ØµØ­ Ø¨ÙØ­Øµ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙƒØ¥Ø¬Ø±Ø§Ø¡ Ø§Ø­ØªØ±Ø§Ø²ÙŠ\\n';
        } else {
          message += 'âš ï¸ *ØªØ­Ø°ÙŠØ±:* ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„\\n';
          message += 'ğŸ” ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ\\n';
          message += 'ğŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ\\n';
        }
        
        message += '\\nğŸ”— *Ø§Ù„Ø±ÙˆØ§Ø¨Ø·:*\\n';
        message += '[ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ](https://github.com/evile92/stellarspeak-monitoring/actions/runs/${{ github.run_id }})\\n';
        message += '[ğŸŒ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹](https://www.stellarspeak.online)';
        
        fs.writeFileSync('telegram-message.txt', message);
        console.log('ğŸ“ Telegram message created successfully');
        console.log('Status: ' + statusIcon + ' ' + finalStatus);
        "
      continue-on-error: true
    
    - name: ğŸ“¤ Send Telegram Notification
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message_file: telegram-message.txt
        format: markdown
        disable_web_page_preview: true
      continue-on-error: true
    
    - name: ğŸ“Š Upload Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: site-guardian-report-${{ github.run_number }}
        path: |
          test-results.json
          telegram-message.txt
        retention-days: 7
