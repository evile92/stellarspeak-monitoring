name: ๐ก๏ธ StellarSpeak Site Guardian

on:
  schedule:
    # ูุญุต ูู 12 ุณุงุนุฉ (ููุชุตู ุงูููู ูุงูุธูุฑ ุจุชูููุช UTC)
    - cron: '0 */12 * * *'
  
  workflow_dispatch:
    inputs:
      test_type:
        description: 'ููุน ุงููุญุต'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - telegram-test

jobs:
  site-monitoring:
    runs-on: ubuntu-latest
    
    steps:
    - name: ๐ฅ Checkout Code
      uses: actions/checkout@v4
      
    - name: ๐ข Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ๐ฆ Install Dependencies
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps chromium
      timeout-minutes: 10
    
    - name: ๐ก๏ธ Run Site Guardian Tests
      id: tests
      run: |
        npx playwright test --reporter=json > test-results.json 2>&1 || echo "Tests completed"
        echo "tests_completed=true" >> $GITHUB_OUTPUT
      env:
        SITE_URL: https://www.stellarspeak.online
        TEST_TYPE: ${{ github.event.inputs.test_type || 'full' }}
        MONITOR_EMAIL: ${{ secrets.MONITOR_EMAIL }}
        MONITOR_PASSWORD: ${{ secrets.MONITOR_PASSWORD }}
      timeout-minutes: 15
    
    - name: ๐ Parse Test Results
      id: parse_results
      run: |
        node -e "
        const fs = require('fs');
        try {
          let results = {};
          let stats = { expected: 0, passed: 0, failed: 0, skipped: 0 };
          
          if (fs.existsSync('test-results.json')) {
            const content = fs.readFileSync('test-results.json', 'utf8');
            results = JSON.parse(content);
            stats = results.stats || stats;
          }
          
          const total = stats.expected || 0;
          const passed = stats.passed || 0;
          const failed = stats.failed || 0;
          const skipped = stats.skipped || 0;
          const duration = results.duration ? (results.duration / 1000).toFixed(2) : '0';
          
          const status = failed > 0 ? '๐ด FAILED' : 'โ PASSED';
          const timestamp = new Date().toLocaleString('ar-SA', {timeZone: 'Asia/Riyadh'});
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repoName = '${{ github.repository }}';
          const actor = '${{ github.actor }}';
          const eventName = '${{ github.event_name }}';
          
          let message = '๐ก๏ธ *StellarSpeak Site Guardian Report*\n';
          message += 'โโโโโโโโโโโโโโโโโโโโโโ\n\n';
          
          message += '๐ *ูุชุงุฆุฌ ุงููุญุต:*\n';
          message += 'โข ุงูุญุงูุฉ: ' + status + '\n';
          message += 'โข ูุฌุญ: โ ' + passed + ' ุงุฎุชุจุงุฑ\n';
          message += 'โข ูุดู: โ ' + failed + ' ุงุฎุชุจุงุฑ\n';
          message += 'โข ุชู ุชุฎุทูู: โญ๏ธ ' + skipped + ' ุงุฎุชุจุงุฑ\n';
          message += 'โข ุงููุฌููุน: ๐ ' + total + ' ุงุฎุชุจุงุฑ\n';
          message += 'โข ูุฏุฉ ุงูุชูููุฐ: โฑ๏ธ ' + duration + ' ุซุงููุฉ\n\n';
          
          message += '๐ *ูุนูููุงุช ุงููุญุต:*\n';
          message += 'โข ุงููููุน: ๐ [stellarspeak.online](https://www.stellarspeak.online)\n';
          message += 'โข ุงูููุช: ๐ ' + timestamp + '\n';
          message += 'โข ููุน ุงูุชุดุบูู: ๐ ' + (eventName === 'schedule' ? 'ุชููุงุฆู (ูู 12 ุณุงุนุฉ)' : 'ูุฏูู') + '\n';
          message += 'โข ุฑูู ุงูุชุดุบูู: #' + runNumber + '\n\n';
          
          if (failed > 0) {
            message += 'โ๏ธ *ุชุญุฐูุฑ - ูุดุงูู ููุชุดูุฉ:*\n';
            message += 'โโโโโโโโโโโโโโโโโโโโโโ\n';
            message += '๐ด ุชู ุงูุชุดุงู *' + failed + ' ูุดููุฉ* ุชุญุชุงุฌ ูุญุต ููุฑู!\n';
            message += '๐ ูููุตุญ ุจูุฑุงุฌุนุฉ ุงูุชูุฑูุฑ ุงูููุตู ููุญุตูู ุนูู ุงูุชูุงุตูู ุงููุงููุฉ\n';
            message += 'โก ูุฏ ุชุคุซุฑ ูุฐู ุงููุดุงูู ุนูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏููู\n\n';
          } else if (passed > 0) {
            message += 'โ *ููุชุงุฒ - ุงููููุน ูุนูู ุจุดูู ูุซุงูู!*\n';
            message += 'โโโโโโโโโโโโโโโโโโโโโโ\n';
            message += '๐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช (' + passed + ') ูุฌุญุช ุจูุง ุฃู ูุดุงูู\n';
            message += '๐ฏ ุงูุฃุฏุงุก ูุงููุธุงุฆู ุชุนูู ุจููุงุกุฉ ุนุงููุฉ\n';
            message += '๐ฏ ูุง ุญุงุฌุฉ ูุฃู ุฅุฌุฑุงุก ูู ุงูููุช ุงูุญุงูู\n\n';
          } else {
            message += 'โ๏ธ *ุชุญุฐูุฑ - ูู ูุชู ุชุดุบูู ุงุฎุชุจุงุฑุงุช:*\n';
            message += 'โโโโโโโโโโโโโโโโโโโโโโ\n';
            message += '๐ง ูุฏ ุชููู ููุงู ูุดููุฉ ุชูููุฉ ูู ูุธุงู ุงููุญุต\n';
            message += '๐จโ๐ป ูููุตุญ ุจูุญุต ุงูุณูุฑูุจุช ูุงูุฅุนุฏุงุฏุงุช\n\n';
          }
          
          message += '๐ *ุฑูุงุจุท ูููุฏุฉ:*\n';
          message += 'โข [ุนุฑุถ ุงูุชูุฑูุฑ ุงูุชูุตููู](${{ github.server_url }}/${{ github.repository }}/actions/runs/' + runId + ')\n';
          message += 'โข [ุฌููุน ุงูุชุดุบููุงุช ุงูุณุงุจูุฉ](${{ github.server_url }}/${{ github.repository }}/actions)\n';
          message += 'โข [ุงููููุน ุงููุจุงุดุฑ](https://www.stellarspeak.online)\n';
          
          fs.writeFileSync('telegram-message.txt', message);
          console.log('status=' + status);
          console.log('passed=' + passed);
          console.log('failed=' + failed);
          console.log('total=' + total);
          
        } catch (error) {
          const errorTime = new Date().toLocaleString('ar-SA', {timeZone: 'Asia/Riyadh'});
          const runId = '${{ github.run_id }}';
          
          const errorMessage = '๐จ *ุฎุทุฃ ูู ูุญุต ูููุน StellarSpeak*\n' +
            'โโโโโโโโโโโโโโโโโโโโโโ\n\n' +
            'โ *ุงููุดููุฉ:* ุชุนุฐุฑ ุชุญููู ูุชุงุฆุฌ ุงููุญุต\n' +
            'โฐ *ุงูููุช:* ' + errorTime + '\n' +
            '๐ง *ุงูุณุจุจ ุงููุญุชูู:* ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุจูุงูุงุช\n\n' +
            '๐ *ุงูุฅุฌุฑุงุก ุงููุทููุจ:*\n' +
            'โข ูุญุต ูุฏูู ูููููุน\n' +
            'โข ูุฑุงุฌุนุฉ ุณุฌูุงุช GitHub Actions\n' +
            'โข ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุณูุฑูุจุช\n\n' +
            '๐ *ุงูุชูุงุตูู:*\n' +
            '[ุนุฑุถ ุชูุงุตูู ุงูุฎุทุฃ ุงููุงููุฉ](${{ github.server_url }}/${{ github.repository }}/actions/runs/' + runId + ')';
          
          fs.writeFileSync('telegram-message.txt', errorMessage);
          console.log('status=ERROR');
        }
        " >> $GITHUB_ENV
      continue-on-error: true
    
    - name: ๐ค Send Telegram Notification
      if: always()
      run: |
        if [ -f "telegram-message.txt" ]; then
          MESSAGE=$(cat telegram-message.txt)
        else
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          MESSAGE="๐ก๏ธ *StellarSpeak Site Check ููุชูู*
          โโโโโโโโโโโโโโโโโโโโโโ
          
          โฐ *ุงูููุช:* $TIMESTAMP UTC
          ๐ *ุงููููุน:* [stellarspeak.online](https://www.stellarspeak.online)
          ๐ *ุงูุญุงูุฉ:* ุชู ุฅููุงู ุงููุญุต
          
          ๐ [ุนุฑุถ ุงูุชูุงุตูู ุงููุงููุฉ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        fi
        
        # ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุนุจุฑ Telegram ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
        RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": $(echo "$MESSAGE" | jq -Rs .),
            \"parse_mode\": \"Markdown\",
            \"disable_web_page_preview\": true
          }")
        
        HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "โ ุชู ุฅุฑุณุงู ุฑุณุงูุฉ Telegram ุจูุฌุงุญ"
        else
          echo "โ๏ธ ูุดู ูู ุฅุฑุณุงู ุฑุณุงูุฉ Telegram (HTTP Code: $HTTP_CODE)"
          echo "$RESPONSE"
        fi
      continue-on-error: true
    
    - name: ๐ Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: site-guardian-report-${{ github.run_number }}
        path: |
          test-results/
          playwright-report/
          test-results.json
          telegram-message.txt
        retention-days: 30

    # ุฅุฑุณุงู ุชูุฑูุฑ ููุตู ุนูุฏ ุงููุดู ุงูุญุฑุฌ
    - name: ๐จ Send Detailed Alert on Critical Failure
      if: failure()
      run: |
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        ALERT_MESSAGE="๐จ *ุชูุจูู ุนุงุฌู - ูุดููุฉ ุญุฑุฌุฉ ูู ุงููููุน*
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        โ *ุญุงูุฉ ุงููุญุต:* ูุดู ูุงูู ูู ุนูููุฉ ุงููุญุต
        ๐ *ููุน ุงููุดููุฉ:* ุฎุทุฃ ุชููู ุญุฑุฌ
        โฐ *ููุช ุงูุงูุชุดุงู:* $TIMESTAMP UTC
        ๐ *ุงููููุน ุงููุชุฃุซุฑ:* [stellarspeak.online](https://www.stellarspeak.online)
        
        ๐ *ุงูุฃุณุจุงุจ ุงููุญุชููุฉ:*
        โข ๐ ูุดููุฉ ูู ุงูุงุชุตุงู ุจุงููููุน ุฃู ุงูุฎุงุฏู
        โข โ๏ธ ุฎุทุฃ ูู ุณูุฑูุจุช ุงููุญุต ุฃู ุงูุชุจุนูุงุช
        โข ๐ ุงููููุน ุบูุฑ ูุชุงุญ ุฃู ุจุทูุก ุฌุฏุงู
        โข ๐ ูุดููุฉ ูู ุจูุงูุงุช ุงููุตุงุฏูุฉ
        โข ๐พ ููุงุฏ ููุงุฑุฏ ุงูุฎุงุฏู
        
        ๐ง *ุงูุฅุฌุฑุงุกุงุช ุงููุทููุจุฉ ููุฑุงู:*
        1๏ธโฃ ูุญุต ุงููููุน ูุฏููุงู ูู ุงููุชุตูุญ
        2๏ธโฃ ูุฑุงุฌุนุฉ ุณุฌูุงุช ุงูุฎุงุฏู (Server Logs)
        3๏ธโฃ ุงูุชุญูู ูู ุญุงูุฉ ุงุณุชุถุงูุฉ ุงููููุน
        4๏ธโฃ ูุญุต ุฅุนุฏุงุฏุงุช GitHub Actions
        5๏ธโฃ ูุฑุงุฌุนุฉ ุงูุณูุฑูุจุช ูุงูุชุจุนูุงุช
        
        ๐ *ูุนูููุงุช ุฅุถุงููุฉ:*
        โข ุฑูู ุงูุชุดุบูู: #${{ github.run_number }}
        โข ููุน ุงูุญุฏุซ: ${{ github.event_name }}
        โข ุงููุฑุน: ${{ github.ref_name }}
        
        ๐ *ุฑูุงุจุท ูููุฉ:*
        โข [ุนุฑุถ ุชูุงุตูู ุงูุฎุทุฃ ุงููุงููุฉ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        โข [ุฌููุน ุงูุชุดุบููุงุช](${{ github.server_url }}/${{ github.repository }}/actions)
        โข [ุงููููุน ุงููุจุงุดุฑ](https://www.stellarspeak.online)
        
        โ๏ธ *ููุงุญุธุฉ:* ูููุตู ุจุญู ุงููุดููุฉ ูู ุฃูุฑุจ ููุช ูููู ูุชุฌูุจ ุชุฃุซูุฑูุง ุนูู ุงููุณุชุฎุฏููู"

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": $(echo "$ALERT_MESSAGE" | jq -Rs .),
            \"parse_mode\": \"Markdown\",
            \"disable_web_page_preview\": false
          }" || echo "โ๏ธ ูุดู ุฅุฑุณุงู ุงูุชูุจูู ุงูุนุงุฌู"
