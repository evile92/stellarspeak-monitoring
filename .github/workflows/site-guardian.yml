name: ğŸ›¡ï¸ StellarSpeak Site Guardian

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test Type'
        required: false
        default: 'quick'
        type: choice
        options:
        - quick
        - full

jobs:
  site-monitoring:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.49.0-jammy
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        # âŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ - Ù‡Ø°Ø§ ÙŠØ³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
        # cache: 'npm'

    - name: ğŸ—‚ï¸ Cache Playwright Browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-v1.49.0
        restore-keys: playwright-${{ runner.os }}-

    - name: ğŸ“¦ Install Dependencies
      run: npm install -D @playwright/test

    - name: ğŸ” Debug Environment
      run: |
        echo "ğŸ“Š Environment Info:"
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "Working directory: $(pwd)"
        echo "Files: $(ls -la)"
        echo "Playwright version: $(npx playwright --version)"

    - name: ğŸ›¡ï¸ Run Site Guardian Tests
      id: tests
      run: |
        echo "ğŸ” Starting Playwright tests..."
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø©
        if timeout 600s npx playwright test --reporter=list; then
          echo "âœ… Tests completed successfully"
          EXIT_CODE=0
        else
          EXIT_CODE=$?
          echo "âš ï¸ Tests completed with exit code: $EXIT_CODE"
        fi
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Playwright
        RESULTS_FOUND=false
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø®ØªÙ„ÙØ©
        for path in "./test-results.json" "./results.json" "./test-results/results.json" "./playwright-report/results.json"; do
          if [ -f "$path" ]; then
            echo "ğŸ“Š Found results at: $path"
            cp "$path" test-results.json
            RESULTS_FOUND=true
            break
          fi
        done
        
        # Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù…Ù„Ù Ù†ØªØ§Ø¦Ø¬ØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ exit code
        if [ "$RESULTS_FOUND" = false ]; then
          echo "âŒ No results file found, creating based on exit code: $EXIT_CODE"
          
          if [ $EXIT_CODE -eq 0 ]; then
            # Ù†Ø¬Ø­Øª ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            EXPECTED_TESTS=15
            echo "{\"stats\":{\"expected\":$EXPECTED_TESTS,\"passed\":$EXPECTED_TESTS,\"failed\":0,\"skipped\":0},\"duration\":5000}" > test-results.json
          else
            # ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            EXPECTED_TESTS=15
            echo "{\"stats\":{\"expected\":$EXPECTED_TESTS,\"passed\":0,\"failed\":$EXPECTED_TESTS,\"skipped\":0},\"duration\":3000}" > test-results.json
          fi
        fi
        
        echo "ğŸ“„ Final test results file:"
        cat test-results.json
        echo "tests_completed=true" >> $GITHUB_OUTPUT
      env:
        SITE_URL: https://www.stellarspeak.online
        TEST_TYPE: ${{ github.event.inputs.test_type || 'quick' }}
        MONITOR_EMAIL: ${{ secrets.MONITOR_EMAIL }}
        MONITOR_PASSWORD: ${{ secrets.MONITOR_PASSWORD }}
      timeout-minutes: 12

    - name: ğŸ“Š Parse Test Results
      run: |
        node -e "
        const fs = require('fs');
        
        console.log('ğŸ” Parsing test results...');
        
        let testResults = {
          stats: { expected: 15, passed: 0, failed: 15, skipped: 0 },
          duration: 3000
        };
        
        try {
          if (fs.existsSync('test-results.json')) {
            const content = fs.readFileSync('test-results.json', 'utf8').trim();
            console.log('ğŸ“„ Raw content length:', content.length);
            console.log('ğŸ“‹ Content preview:', content.substring(0, 200));
            
            if (content && content !== '') {
              testResults = JSON.parse(content);
              console.log('âœ… Successfully parsed results:', JSON.stringify(testResults.stats, null, 2));
            }
          } else {
            console.log('âŒ Test results file not found, using defaults');
          }
        } catch (error) {
          console.log('âš ï¸ Error reading results, using defaults:', error.message);
        }
        
        const stats = testResults.stats || {};
        const total = stats.expected || 0;
        const passed = stats.passed || 0;
        const failed = stats.failed || 0;
        const skipped = stats.skipped || 0;
        const duration = (testResults.duration / 1000).toFixed(1);
        
        // ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
        let status;
        if (total === 0) {
          status = 'ğŸ”´ NO_TESTS';
        } else if (failed > 0) {
          status = 'ğŸ”´ FAILED';
        } else if (passed > 0) {
          status = 'âœ… PASSED';
        } else {
          status = 'âš ï¸ UNKNOWN';
        }
        
        const timestamp = new Date().toLocaleString('ar-SA-u-nu-latn', {timeZone: 'Asia/Riyadh'});
        const runNumber = '${{ github.run_number }}';
        const runId = '${{ github.run_id }}';
        const repoName = '${{ github.repository }}';
        const actor = '${{ github.actor }}';
        const eventName = '${{ github.event_name }}';
        
        let message = 'ğŸ›¡ï¸ *StellarSpeak Site Guardian Report*\\\\n';
        message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\n\\\\n';
        
        message += 'ğŸ“Š *Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ:*\\\\n';
        message += 'â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ' + status + '\\\\n';
        message += 'â€¢ Ù†Ø¬Ø­: âœ… ' + passed + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\n';
        message += 'â€¢ ÙØ´Ù„: âŒ ' + failed + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\n';
        message += 'â€¢ ØªÙ… ØªØ®Ø·ÙŠÙ‡: â­ï¸ ' + skipped + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\n';
        message += 'â€¢ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ğŸ“ˆ ' + total + ' Ø§Ø®ØªØ¨Ø§Ø±\\\\n';
        message += 'â€¢ Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°: â±ï¸ ' + duration + ' Ø«Ø§Ù†ÙŠØ©\\\\n\\\\n';
        
        message += 'ğŸ” *Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ­Øµ:*\\\\n';
        message += 'â€¢ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ğŸŒ [stellarspeak.online](https://www.stellarspeak.online)\\\\n';
        message += 'â€¢ Ø§Ù„ÙˆÙ‚Øª: ğŸ• ' + timestamp + '\\\\n';
        message += 'â€¢ Ù†ÙˆØ¹ Ø§Ù„ØªØ´ØºÙŠÙ„: ğŸ”„ ' + (eventName === 'schedule' ? 'ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ„ 12 Ø³Ø§Ø¹Ø©)' : 'ÙŠØ¯ÙˆÙŠ') + '\\\\n';
        message += 'â€¢ Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: #' + runNumber + '\\\\n\\\\n';
        
        if (total === 0) {
          message += 'ğŸš¨ *Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ - Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:*\\\\n';
          message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\n';
          message += 'ğŸ”§ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Playwright Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©\\\\n';
          message += 'ğŸŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Container\\\\n';
          message += 'ğŸ‘¨â€ğŸ’» ÙŠØªØ·Ù„Ø¨ ÙØ­Øµ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\\\\n';
          message += 'âš¡ Ù‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù… ÙŠØªÙ… ÙØ­ØµÙ‡ ÙØ¹Ù„ÙŠØ§Ù‹\\\\n\\\\n';
        } else if (failed > 0) {
          message += 'âš ï¸ *ØªØ­Ø°ÙŠØ± - Ù…Ø´Ø§ÙƒÙ„ Ù…ÙƒØªØ´ÙØ©:*\\\\n';
          message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\n';
          message += 'ğŸ”´ ØªÙ… Ø§ÙƒØªØ´Ø§Ù *' + failed + ' Ù…Ø´ÙƒÙ„Ø©* ØªØ­ØªØ§Ø¬ ÙØ­Øµ ÙÙˆØ±ÙŠ!\\\\n';
          message += 'ğŸ” ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©\\\\n';
          message += 'âš¡ Ù‚Ø¯ ØªØ¤Ø«Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø¹Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\\\\n\\\\n';
        } else if (passed > 0) {
          message += 'âœ… *Ù…Ù…ØªØ§Ø² - Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!*\\\\n';
          message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\n';
          message += 'ğŸš€ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (' + passed + ') Ù†Ø¬Ø­Øª Ø¨Ù„Ø§ Ø£ÙŠ Ù…Ø´Ø§ÙƒÙ„\\\\n';
          message += 'ğŸ’¯ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù ØªØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ©\\\\n';
          message += 'ğŸ¯ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ\\\\n\\\\n';
        } else {
          message += 'âš ï¸ *Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©:*\\\\n';
          message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\n';
          message += 'ğŸ” ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ø¶Ø­Ø©\\\\n';
          message += 'ğŸ”§ ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\\\\n\\\\n';
        }
        
        message += 'ğŸ“‹ *Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©:*\\\\n';
        message += 'â€¢ [Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ](https://github.com/' + repoName + '/actions/runs/' + runId + ')\\\\n';
        message += 'â€¢ [Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©](https://github.com/' + repoName + '/actions)\\\\n';
        message += 'â€¢ [Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±](https://www.stellarspeak.online)\\\\n';
        
        fs.writeFileSync('telegram-message.txt', message);
        console.log('status=' + status);
        console.log('passed=' + passed);
        console.log('failed=' + failed);
        console.log('total=' + total);
        "
      continue-on-error: true

    - name: ğŸ” Debug Secrets
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Checking Telegram Secrets..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          TOKEN_LENGTH=$(echo -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" | wc -c)
          echo "âœ… TELEGRAM_BOT_TOKEN is set (length: $TOKEN_LENGTH characters)"
        else
          echo "âŒ TELEGRAM_BOT_TOKEN is NOT set - Please add it in repository secrets"
        fi
        
        if [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          echo "âœ… TELEGRAM_CHAT_ID is set: ${{ secrets.TELEGRAM_CHAT_ID }}"
        else
          echo "âŒ TELEGRAM_CHAT_ID is NOT set - Please add it in repository secrets"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: ğŸ“¤ Send Telegram Notification
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message_file: telegram-message.txt
        format: markdown
        disable_web_page_preview: true

    - name: ğŸ“Š Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: site-guardian-report-${{ github.run_number }}
        path: |
          test-results/
          playwright-report/
          test-results.json
          telegram-message.txt
        retention-days: 30
        if-no-files-found: warn

    - name: ğŸš¨ Send Detailed Alert on Critical Failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸš¨ **CRITICAL: StellarSpeak Monitoring System Failure**
          
          âŒ **Issue:** Complete system failure during workflow execution
          â° **Time:** $(date)
          ğŸ”§ **Run:** #${{ github.run_number }}
          
          ğŸš€ **Action Required:** 
          â€¢ Manual site check immediately
          â€¢ Review GitHub Actions logs
          â€¢ Verify system configuration
          
          ğŸ”— [View Detailed Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        format: markdown
